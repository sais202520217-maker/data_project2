# ============================================
# ì„œìš¸ì‹œ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì´ìš© ë°ì´í„° ë¶„ì„
# Streamlit Cloud í˜¸í™˜ ìµœì¢… ì½”ë“œ
# ============================================

# 1. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
import streamlit as st          # Streamlit ì›¹ì•±
import pandas as pd             # ë°ì´í„° ë¶„ì„
import plotly.express as px     # ì‹œê°í™” (matplotlib ëŒ€ì²´)

# --------------------------------------------
# 2. Streamlit ê¸°ë³¸ ì„¤ì •
# --------------------------------------------
st.set_page_config(
    page_title="ì„œìš¸ì‹œ ë”°ë¦‰ì´ ì´ìš© ë¶„ì„",
    layout="wide"
)

st.title("ğŸš² ì„œìš¸ì‹œ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì´ìš© ë¶„ì„")
st.write("ëŒ€ì—¬Â·ë°˜ë‚© ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì—¬ì†Œë³„ ì´ìš©ëŸ‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.")

# --------------------------------------------
# 3. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# --------------------------------------------
# CSV íŒŒì¼ì€ main.pyì™€ ê°™ì€ í´ë”ì— ìˆì–´ì•¼ í•¨
df = pd.read_csv("bcycl_20251221.csv", encoding="cp949")

st.subheader("ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(df.head())

# --------------------------------------------
# 4. ëŒ€ì—¬ ê±´ìˆ˜ ê³„ì‚° (ì¶œë°œ ëŒ€ì—¬ì†Œ ê¸°ì¤€)
# --------------------------------------------
rentals = (
    df.groupby("ì‹œì‘_ëŒ€ì—¬ì†Œëª…")["ì „ì²´_ê±´ìˆ˜"]
    .sum()
    .reset_index()
)
rentals.columns = ["ëŒ€ì—¬ì†Œëª…", "ëŒ€ì—¬ê±´ìˆ˜"]

# --------------------------------------------
# 5. ë°˜ë‚© ê±´ìˆ˜ ê³„ì‚° (ë„ì°© ëŒ€ì—¬ì†Œ ê¸°ì¤€)
# --------------------------------------------
returns = (
    df.groupby("ì¢…ë£Œ_ëŒ€ì—¬ì†Œëª…")["ì „ì²´_ê±´ìˆ˜"]
    .sum()
    .reset_index()
)
returns.columns = ["ëŒ€ì—¬ì†Œëª…", "ë°˜ë‚©ê±´ìˆ˜"]

# --------------------------------------------
# 6. ëŒ€ì—¬ + ë°˜ë‚© ë°ì´í„° í•©ì¹˜ê¸°
# --------------------------------------------
station_stats = pd.merge(
    rentals,
    returns,
    on="ëŒ€ì—¬ì†Œëª…",
    how="outer"
).fillna(0)

# --------------------------------------------
# 7. ì´ ì´ìš© ê±´ìˆ˜ ê³„ì‚°
# --------------------------------------------
station_stats["ì´ì´ìš©ê±´ìˆ˜"] = (
    station_stats["ëŒ€ì—¬ê±´ìˆ˜"] + station_stats["ë°˜ë‚©ê±´ìˆ˜"]
)

# ì´ìƒ ë°ì´í„° ì œê±°
station_stats = station_stats[station_stats["ì´ì´ìš©ê±´ìˆ˜"] > 0]

st.subheader("ì „ì²˜ë¦¬ëœ ëŒ€ì—¬ì†Œë³„ ì´ìš© ë°ì´í„°")
st.dataframe(station_stats.head())

# --------------------------------------------
# 8. Min-Max ì •ê·œí™”
# --------------------------------------------
min_val = station_stats["ì´ì´ìš©ê±´ìˆ˜"].min()
max_val = station_stats["ì´ì´ìš©ê±´ìˆ˜"].max()

station_stats["ì´ìš©ê±´ìˆ˜_ì •ê·œí™”"] = (
    station_stats["ì´ì´ìš©ê±´ìˆ˜"] - min_val
) / (max_val - min_val)

# --------------------------------------------
# 9. ì´ìš©ëŸ‰ Top 10 ëŒ€ì—¬ì†Œ ì¶”ì¶œ
# --------------------------------------------
top10 = (
    station_stats
    .sort_values(by="ì´ì´ìš©ê±´ìˆ˜", ascending=False)
    .head(10)
)

# --------------------------------------------
# 10. Plotlyë¡œ ì‹œê°í™” (Streamlit ìµœì í™”)
# --------------------------------------------
fig = px.bar(
    top10,
    x="ì´ì´ìš©ê±´ìˆ˜",
    y="ëŒ€ì—¬ì†Œëª…",
    orientation="h",
    title="ì„œìš¸ì‹œ ë”°ë¦‰ì´ ì´ìš© ê±´ìˆ˜ Top 10 ëŒ€ì—¬ì†Œ",
    labels={
        "ì´ì´ìš©ê±´ìˆ˜": "ì´ ì´ìš© ê±´ìˆ˜",
        "ëŒ€ì—¬ì†Œëª…": "ëŒ€ì—¬ì†Œëª…"
    }
)

# 1ë“±ì´ ìœ„ì— ì˜¤ë„ë¡ ì •ë ¬
fig.update_layout(yaxis=dict(autorange="reversed"))

st.subheader("ğŸ“Š ì´ìš© ê±´ìˆ˜ Top 10 ëŒ€ì—¬ì†Œ")
st.plotly_chart(fig, use_container_width=True)

# --------------------------------------------
# 11. ë¶„ì„ ìš”ì•½
# --------------------------------------------
st.markdown("""
### ğŸ“Œ ë¶„ì„ ìš”ì•½
- ëŒ€ì—¬ì™€ ë°˜ë‚© ë°ì´í„°ë¥¼ ê²°í•©í•˜ì—¬ ëŒ€ì—¬ì†Œë³„ ì´ ì´ìš© ê±´ìˆ˜ë¥¼ ê³„ì‚°í•¨
- ì •ê·œí™”ë¥¼ í†µí•´ ëŒ€ì—¬ì†Œ ê°„ ìƒëŒ€ì  ì´ìš©ëŸ‰ ë¹„êµê°€ ê°€ëŠ¥í•¨
- ì¼ë¶€ ëŒ€ì—¬ì†Œì— ì´ìš©ì´ ì§‘ì¤‘ë˜ëŠ” í˜„ìƒì„ í™•ì¸í•  ìˆ˜ ìˆìŒ
""")
