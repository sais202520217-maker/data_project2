# ============================================
# ì„œìš¸ì‹œ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì´ìš© ë°ì´í„° ë¶„ì„
# Streamlit ì›¹ì•±ìš© ì½”ë“œ
# ============================================

# 1. í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
import streamlit as st              # ì›¹ í™”ë©´ì„ ë§Œë“¤ê¸° ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
import pandas as pd                 # ë°ì´í„° ë¶„ì„ ë¼ì´ë¸ŒëŸ¬ë¦¬
import matplotlib.pyplot as plt     # ê·¸ë˜í”„ ì‹œê°í™” ë¼ì´ë¸ŒëŸ¬ë¦¬

# --------------------------------------------
# 2. Streamlit í˜ì´ì§€ ê¸°ë³¸ ì„¤ì •
# --------------------------------------------
st.set_page_config(
    page_title="ì„œìš¸ì‹œ ë”°ë¦‰ì´ ì´ìš© ë¶„ì„",
    layout="wide"
)

st.title("ğŸš² ì„œìš¸ì‹œ ë”°ë¦‰ì´ ëŒ€ì—¬ì†Œ ì´ìš© ë¶„ì„")
st.write("ëŒ€ì—¬ì†Œë³„ ëŒ€ì—¬Â·ë°˜ë‚© ë°ì´í„°ë¥¼ ì´ìš©í•´ ì´ìš©ëŸ‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.")

# --------------------------------------------
# 3. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# --------------------------------------------
# ê°™ì€ í´ë”ì— ìˆëŠ” CSV íŒŒì¼ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
# cp949 ì¸ì½”ë”©ì€ ê³µê³µë°ì´í„°ì—ì„œ ìì£¼ ì‚¬ìš©ë©ë‹ˆë‹¤.
df = pd.read_csv("bcycl_20251221.csv", encoding="cp949")

# ë°ì´í„°ê°€ ì˜ ë¶ˆëŸ¬ì™€ì¡ŒëŠ”ì§€ í™•ì¸
st.subheader("ì›ë³¸ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°")
st.dataframe(df.head())

# --------------------------------------------
# 4. ëŒ€ì—¬ ê±´ìˆ˜ ê³„ì‚° (ì¶œë°œ ëŒ€ì—¬ì†Œ ê¸°ì¤€)
# --------------------------------------------
# 'ì‹œì‘_ëŒ€ì—¬ì†Œëª…'ì´ ê°™ì€ í–‰ë¼ë¦¬ ë¬¶ì–´ì„œ
# 'ì „ì²´_ê±´ìˆ˜'ë¥¼ ëª¨ë‘ ë”í•©ë‹ˆë‹¤.
rentals = (
    df.groupby("ì‹œì‘_ëŒ€ì—¬ì†Œëª…")["ì „ì²´_ê±´ìˆ˜"]
    .sum()
    .reset_index()
)

# ì»¬ëŸ¼ ì´ë¦„ì„ ì´í•´í•˜ê¸° ì‰½ê²Œ ë³€ê²½
rentals.columns = ["ëŒ€ì—¬ì†Œëª…", "ëŒ€ì—¬ê±´ìˆ˜"]

# --------------------------------------------
# 5. ë°˜ë‚© ê±´ìˆ˜ ê³„ì‚° (ë„ì°© ëŒ€ì—¬ì†Œ ê¸°ì¤€)
# --------------------------------------------
returns = (
    df.groupby("ì¢…ë£Œ_ëŒ€ì—¬ì†Œëª…")["ì „ì²´_ê±´ìˆ˜"]
    .sum()
    .reset_index()
)

returns.columns = ["ëŒ€ì—¬ì†Œëª…", "ë°˜ë‚©ê±´ìˆ˜"]

# --------------------------------------------
# 6. ëŒ€ì—¬ + ë°˜ë‚© ë°ì´í„° í•©ì¹˜ê¸°
# --------------------------------------------
# outer joinì„ ì‚¬ìš©í•˜ì—¬
# ëŒ€ì—¬ë§Œ ìˆê±°ë‚˜ ë°˜ë‚©ë§Œ ìˆëŠ” ëŒ€ì—¬ì†Œë„ ëª¨ë‘ í¬í•¨í•©ë‹ˆë‹¤.
station_stats = pd.merge(
    rentals,
    returns,
    on="ëŒ€ì—¬ì†Œëª…",
    how="outer"
).fillna(0)  # ê°’ì´ ì—†ëŠ” ê³³ì€ 0ìœ¼ë¡œ ì±„ì›€

# --------------------------------------------
# 7. ì´ ì´ìš© ê±´ìˆ˜ ê³„ì‚°
# --------------------------------------------
station_stats["ì´ì´ìš©ê±´ìˆ˜"] = (
    station_stats["ëŒ€ì—¬ê±´ìˆ˜"] + station_stats["ë°˜ë‚©ê±´ìˆ˜"]
)

# í˜¹ì‹œ ëª¨ë¥¼ ì´ìƒ ë°ì´í„° ì œê±° (0 ì´í•˜)
station_stats = station_stats[station_stats["ì´ì´ìš©ê±´ìˆ˜"] > 0]

st.subheader("ì „ì²˜ë¦¬ëœ ëŒ€ì—¬ì†Œë³„ ì´ìš© ë°ì´í„°")
st.dataframe(station_stats.head())

# --------------------------------------------
# 8. Min-Max ì •ê·œí™”
# --------------------------------------------
# ì„œë¡œ ë‹¤ë¥¸ í¬ê¸°ì˜ ë°ì´í„°ë¥¼
# 0 ~ 1 ì‚¬ì´ ê°’ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµí•˜ê¸° ì‰½ê²Œ ë§Œë“­ë‹ˆë‹¤.
min_val = station_stats["ì´ì´ìš©ê±´ìˆ˜"].min()
max_val = station_stats["ì´ì´ìš©ê±´ìˆ˜"].max()

station_stats["ì´ìš©ê±´ìˆ˜_ì •ê·œí™”"] = (
    station_stats["ì´ì´ìš©ê±´ìˆ˜"] - min_val
) / (max_val - min_val)

# --------------------------------------------
# 9. ì´ìš©ëŸ‰ ìƒìœ„ Top 10 ëŒ€ì—¬ì†Œ ì„ íƒ
# --------------------------------------------
top10 = (
    station_stats
    .sort_values(by="ì´ì´ìš©ê±´ìˆ˜", ascending=False)
    .head(10)
)

# --------------------------------------------
# 10. ì‹œê°í™” (matplotlib)
# --------------------------------------------
# Streamlit Cloudì—ì„œëŠ” ê¸°ë³¸ í°íŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
plt.rcParams["font.family"] = "DejaVu Sans"

fig, ax = plt.subplots(figsize=(10, 6))

# ê°€ë¡œ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„±
ax.barh(
    top10["ëŒ€ì—¬ì†Œëª…"],
    top10["ì´ì´ìš©ê±´ìˆ˜"]
)

# ê°€ì¥ ë§ì´ ì´ìš©ëœ ëŒ€ì—¬ì†Œê°€ ìœ„ì— ì˜¤ë„ë¡ ë’¤ì§‘ê¸°
ax.invert_yaxis()

# ê·¸ë˜í”„ ì œëª©ê³¼ ì¶• ì´ë¦„ ì„¤ì •
ax.set_title("ì„œìš¸ì‹œ ë”°ë¦‰ì´ ì´ìš© ê±´ìˆ˜ Top 10 ëŒ€ì—¬ì†Œ")
ax.set_xlabel("ì´ ì´ìš© ê±´ìˆ˜")
ax.set_ylabel("ëŒ€ì—¬ì†Œëª…")

# ëˆˆê¸ˆì„  ì¶”ê°€
ax.grid(axis="x", linestyle="--", alpha=0.5)

# Streamlitì— ê·¸ë˜í”„ ì¶œë ¥
st.subheader("ğŸ“Š ì´ìš© ê±´ìˆ˜ Top 10 ëŒ€ì—¬ì†Œ")
st.pyplot(fig)

# --------------------------------------------
# 11. ë¶„ì„ ìš”ì•½ ì¶œë ¥
# --------------------------------------------
st.markdown("""
### ğŸ“Œ ë¶„ì„ ìš”ì•½
- ëŒ€ì—¬ì™€ ë°˜ë‚© ë°ì´í„°ë¥¼ ê²°í•©í•˜ì—¬ ëŒ€ì—¬ì†Œë³„ ì´ ì´ìš© ê±´ìˆ˜ë¥¼ ê³„ì‚°í•¨
- Min-Max ì •ê·œí™”ë¥¼ í†µí•´ ëŒ€ì—¬ì†Œ ê°„ ì´ìš©ëŸ‰ ë¹„êµ ê°€ëŠ¥
- ìƒìœ„ 10ê°œ ëŒ€ì—¬ì†ŒëŠ” íŠ¹ì • ì§€ì—­ì— ì´ìš©ì´ ì§‘ì¤‘ë˜ëŠ” ê²½í–¥ì„ ë³´ì„
""")
